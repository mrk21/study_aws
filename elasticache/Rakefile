require '../util'

desc 'Creates an ElastiCache instance'
task :create do
  security_gruop_ids = aws <<-SH
    aws ec2 describe-security-groups
      --filters  'Name=tag-key,Values=Name'
                 'Name=tag-value,Values=default'
      --query    'SecurityGroups[*].GroupId'
  SH
  
  # Creates a cache cluster for Redis
  aws <<-SH, binding
    aws elasticache create-cache-cluster
      --cache-cluster-id            test-elasticache
      --cache-node-type             cache.t1.micro
      --engine                      redis
      --engine-version              2.8.23
      --num-cache-nodes             1
      --cache-parameter-group-name  default.redis2.8
      --security-group-ids          <%= security_gruop_ids.join(' ') %>
  SH
end

desc 'Access the ElastiCache instance'
task :access do
  # Gets an ElastiCache information
  # @see  $ aws elasticache describe-cache-clusters help
  cluster = aws <<-SH, binding
    aws elasticache describe-cache-clusters
      --cache-cluster-id  test-elasticache
      --show-cache-node-info
      --query 'CacheClusters[0]'
  SH
  cache_host = cluster['CacheNodes'][0]['Endpoint']['Address']
  cache_port = cluster['CacheNodes'][0]['Endpoint']['Port']
  
  ec2s = create_or_get_instance tag: 'test-elasticache'
  dns = ec2s[0]['Instances'][0]['PublicDnsName']
  
  ssh host: dns, cmd: 'sudo yum --enablerepo=epel -y install redis'
  ssh host: dns, cmd: "echo 'keys *' | redis-cli -h #{cache_host} -p #{cache_port}"
end
